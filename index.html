<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Odigos Resource Calculator</title>
    <style>
      :root { --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: #111827; }
      .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
      h1 { margin: 0 0 6px; }
      .muted { color: var(--muted); }
      .card { background: white; border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: end; }
      @media (max-width: 820px) { .row { grid-template-columns: 1fr; } }
      label { display:block; font-weight: 650; margin-bottom: 6px; }
      input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border); border-radius: 10px; }
      button { padding: 10px 14px; font-size: 16px; border-radius: 10px; border: 1px solid var(--border); background: #111827; color: white; cursor: pointer; }
      button:active { transform: translateY(1px); }
      .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); font-size: 13px; }
      table { width: 100%; border-collapse: collapse; margin-top: 14px; }
      th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
      th { font-size: 13px; color: var(--muted); font-weight: 700; }
      .totals { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
      @media (max-width: 820px) { .totals { grid-template-columns: 1fr; } }
      .stat { border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
      .stat .k { color: var(--muted); font-size: 13px; }
      .stat .v { font-size: 20px; font-weight: 750; margin-top: 4px; }
      .warn { color: #92400e; background: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 12px; margin-top: 12px; }
      code { background: #f3f4f6; padding: 2px 6px; border-radius: 8px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Odigos Resource Calculator</h1>
      <p class="muted">
        Enter a <b>Node Count</b>. We’ll estimate Odigos CPU/Memory requests & limits using the template sizing rules.
        <span class="pill" id="templatePill">Template: —</span>
      </p>

      <div class="card">
        <div class="row">
          <div>
            <label for="nodes">Node Count</label>
            <input id="nodes" type="number" min="1" step="1" value="10" />
            <div class="muted" style="font-size:13px; margin-top:6px;">
              Small: ≤10, Medium: 11–30, Large: 31–100, XL: ≥101
            </div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="calcBtn">Calculate</button>
          </div>
          <div id="notice"></div>
        </div>

        <div class="totals" id="totals"></div>

        <table id="table">
          <thead>
            <tr>
              <th>Component</th>
              <th>Replicas</th>
              <th>CPU Request</th>
              <th>CPU Limit</th>
              <th>Mem Request</th>
              <th>Mem Limit</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="muted" style="font-size:13px; margin-top:10px;">
          Notes: <code>odiglet</code> is treated as a DaemonSet (replicas = nodes). <code>gateway</code> replicas = ceil(nodes/10).
        </div>
      </div>
    </div>

    <script>
      // --- helpers ---
      const MiB = 1024 * 1024;

      function fmtMilliCpu(m) {
        // show both millicores and cores
        const cores = m / 1000;
        const coresStr = Number.isInteger(cores) ? cores.toFixed(0) : cores.toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
        return `${m} mCPU (${coresStr} cores)`;
      }

      function fmtBytes(b) {
        const mib = b / MiB;
        if (mib < 1024) return `${mib.toFixed(1)} MiB`;
        const gib = mib / 1024;
        return `${gib.toFixed(2)} GiB`;
      }

      function ceilDiv(a, b) {
        return Math.ceil(a / b);
      }

      function pickTemplate(nodes) {
        if (nodes <= 10) return "small";
        if (nodes <= 30) return "medium";
        if (nodes <= 100) return "large";
        return "xl";
      }

      // --- template data (PER POD) ---
      // CPU in millicores, memory in bytes
      // For SMALL, values come from what you pasted.
      // Replicas for non-scaling components are based on the sample pod list.
      const templates = {
        small: {
          components: {
            odiglet:        { cpuReq: 340, cpuLim: 550, memReq: 681574400, memLim: 943718400,  replicaRule: "daemonset" },
            autoscaler:     { cpuReq: 10,  cpuLim: 500, memReq: 67108864,  memLim: 536870912,  replicas: 1 },
            gateway:        { cpuReq: 300, cpuLim: 300, memReq: 314572800, memLim: 314572800,  replicaRule: "gateway_per_10_nodes" },
            instrumentor:   { cpuReq: 10,  cpuLim: 500, memReq: 67108864,  memLim: 536870912,  replicas: 2 }, // two pods in your small sample
            scheduler:      { cpuReq: 10,  cpuLim: 500, memReq: 67108864,  memLim: 536870912,  replicas: 1 },
            ui:             { cpuReq: 10,  cpuLim: 500, memReq: 67108864,  memLim: 536870912,  replicas: 1 },
          }
        },

        // placeholders for later (you'll provide numbers)
        medium: { components: {} },
        large:  { components: {} },
        xl:     { components: {} },
      };

      function computeReplicas(comp, nodes) {
        if (comp.replicaRule === "daemonset") return nodes;
        if (comp.replicaRule === "gateway_per_10_nodes") return ceilDiv(nodes, 10);
        return comp.replicas ?? 1;
      }

      function calculate(nodes) {
        const templateName = pickTemplate(nodes);
        const template = templates[templateName];

        const templatePill = document.getElementById("templatePill");
        templatePill.textContent = `Template: ${templateName}`;

        const notice = document.getElementById("notice");
        notice.innerHTML = "";

        // If user picked a template that we haven't filled in yet, warn and fall back to small
        let activeTemplateName = templateName;
        let activeTemplate = template;

        if (!activeTemplate || !activeTemplate.components || Object.keys(activeTemplate.components).length === 0) {
          activeTemplateName = "small";
          activeTemplate = templates.small;

          notice.innerHTML =
            `<div class="warn"><b>${templateName}</b> template isn’t filled in yet, so this is showing <b>small</b> numbers as a placeholder.</div>`;
          document.getElementById("templatePill").textContent = `Template: ${templateName} (showing small placeholder)`;
        }

        const rows = [];
        let totalCpuReq = 0, totalCpuLim = 0, totalMemReq = 0, totalMemLim = 0;

        for (const [name, comp] of Object.entries(activeTemplate.components)) {
          const replicas = computeReplicas(comp, nodes);

          const cpuReq = comp.cpuReq * replicas;
          const cpuLim = comp.cpuLim * replicas;
          const memReq = comp.memReq * replicas;
          const memLim = comp.memLim * replicas;

          totalCpuReq += cpuReq;
          totalCpuLim += cpuLim;
          totalMemReq += memReq;
          totalMemLim += memLim;

          rows.push({
            name,
            replicas,
            cpuReq,
            cpuLim,
            memReq,
            memLim,
          });
        }

        rows.sort((a, b) => a.name.localeCompare(b.name));

        // totals cards
        const totalsEl = document.getElementById("totals");
        totalsEl.innerHTML = `
          <div class="stat">
            <div class="k">Total CPU Request</div>
            <div class="v">${fmtMilliCpu(totalCpuReq)}</div>
          </div>
          <div class="stat">
            <div class="k">Total CPU Limit</div>
            <div class="v">${fmtMilliCpu(totalCpuLim)}</div>
          </div>
          <div class="stat">
            <div class="k">Total Memory Request</div>
            <div class="v">${fmtBytes(totalMemReq)}</div>
          </div>
          <div class="stat">
            <div class="k">Total Memory Limit</div>
            <div class="v">${fmtBytes(totalMemLim)}</div>
          </div>
        `;

        // table
        const tbody = document.querySelector("#table tbody");
        tbody.innerHTML = "";
        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="font-weight:700;">${r.name}</td>
            <td>${r.replicas}</td>
            <td>${fmtMilliCpu(r.cpuReq)}</td>
            <td>${fmtMilliCpu(r.cpuLim)}</td>
            <td>${fmtBytes(r.memReq)}</td>
            <td>${fmtBytes(r.memLim)}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      // wire up UI
      const nodesEl = document.getElementById("nodes");
      const btn = document.getElementById("calcBtn");

      function run() {
        const nodes = Number(nodesEl.value);
        if (!Number.isFinite(nodes) || nodes < 1) {
          alert("Please enter a node count >= 1");
          return;
        }
        calculate(Math.floor(nodes));
      }

      btn.addEventListener("click", run);
      nodesEl.addEventListener("keydown", (e) => { if (e.key === "Enter") run(); });

      // initial render
      run();
    </script>
  </body>
</html>
